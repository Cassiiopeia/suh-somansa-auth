name: PUBLISH-SUH-NEXUS-REPOSITORY
on:
  push:
    branches:
      - deploy  # deploy ë¸Œëœì¹˜ í‘¸ì‹œë  ë•Œ íŠ¸ë¦¬ê±°
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

permissions:
  contents: write  # README.md ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ê¶Œí•œ

jobs:
  # Job 1: Nexusì— ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°°í¬
  publish-nexus:
    name: Nexus Repository ë°°í¬
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: í˜„ì¬ ë²„ì „ ì¶”ì¶œ
        id: get_version
        run: |
          if [ -f "CHANGELOG.json" ]; then
            VERSION=$(jq -r '.metadata.currentVersion // .currentVersion' CHANGELOG.json)
            echo "Found version in CHANGELOG.json: $VERSION"
          else
            VERSION=$(grep "version = '" build.gradle | sed "s/version = '//" | sed "s/'//")
            echo "Found version in build.gradle: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ë°°í¬í•  ë²„ì „: $VERSION"

      - name: gradle.properties ìƒì„±
        run: |
          echo -e "${{ secrets.GRADLE_PROPERTIES }}" > gradle.properties

      - name: gradle.properties í™•ì¸ (ë””ë²„ê·¸)
        run: cat gradle.properties | grep -v password

      - name: Nexus Repositoryì— ë°°í¬
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "ğŸš€ suh-somansa-auth v$VERSION Nexus ë°°í¬ ì‹œì‘..."
          ./gradlew publish -Pversion=$VERSION
          echo "âœ… Nexus Repository ë°°í¬ ì™„ë£Œ!"

  # Job 2: README.md ì—…ë°ì´íŠ¸ (Job 1 ì™„ë£Œ í›„ ì‹¤í–‰)
  update-readme:
    name: README.md ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    needs: publish-nexus
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: README.md ë²„ì „ ì—…ë°ì´íŠ¸
        run: |
          VERSION="${{ needs.publish-nexus.outputs.version }}"
          echo "ğŸ“ README.md ë²„ì „ì„ $VERSIONìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì¤‘..."
          
          # README.mdì—ì„œ "## ğŸ“‹ ìµœì‹  ë²„ì „ : X.X.X" ë¶€ë¶„ ì—…ë°ì´íŠ¸
          sed -i "s/## ğŸ“‹ ìµœì‹  ë²„ì „ : .*/## ğŸ“‹ ìµœì‹  ë²„ì „ : $VERSION/" README.md
          
          echo "âœ… README.md ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          VERSION="${{ needs.publish-nexus.outputs.version }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add README.md
          
          if git diff --staged --quiet; then
            echo "ğŸ“ README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            git commit -m "README ì—…ë°ì´íŠ¸ : v$VERSION README.md ë²„ì „ ì •ë³´ ì—…ë°ì´íŠ¸ [skip ci]"
            git push
            echo "âœ… README.md ë³€ê²½ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          VERSION="${{ needs.publish-nexus.outputs.version }}"
          echo "ğŸ‰ suh-somansa-auth v$VERSION ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“¦ Nexus Repository: ë°°í¬ ì™„ë£Œ"
          echo "ğŸ“š README.md: ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "ğŸ”— Repository: https://github.com/${{ github.repository }}"